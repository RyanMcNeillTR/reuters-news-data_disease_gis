---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidymodels)
library(tidyverse)
library(data.table)

library(doParallel)

```

Set up parallel processing.

```{r}

doParallel::registerDoParallel()

```

Read in data.

```{r}

long_data_joined_read <- fread("regression_ready.csv")

```
Split data into testing and training sets, stratified by spillover status.

```{r}

set.seed(123)

data_split <- long_data_joined_read %>% 
  select(!population) %>% 
  initial_split(strata = is_spillover_fixed)

data_train <- training(data_split)
data_test <- testing(data_split)

rm(data_split)
rm(long_data_joined_read)

```

Set up validation folds.

```{r}

set.seed(234)

val_set <- validation_split(data_train, 
                            strata = is_spillover_fixed, 
                            prop = 0.80)

```

Set up? check for? parallel processing.

```{r}
cores <- parallel::detectCores()
cores
#> [1] 8
```

Set up our random forest model tuning specification, specifying which parameters we plan to tune and our engine for the random forest, ranger.

```{r}

rf_tune_spec <- rand_forest(mtry = tune(), 
              min_n = tune(), 
              trees = 1000) %>% 
  set_engine("ranger", num.threads = cores) %>% 
  set_mode("classification")

```

Set up recipe we will use with the random forest model. 

*** Do we actually need to normalize the skewed variables for a random forest?

```{r}

rf_rec <- recipe(is_spillover_fixed ~ ., data = data_train) %>%
  update_role(rowid, new_role ="ID") %>%
  step_string2factor(is_spillover_fixed) %>%
  step_relevel(is_spillover_fixed, ref_level = "Yes") %>%
  themis::step_downsample(is_spillover_fixed, under_ratio = 1) %>%
  step_sqrt(bat_species_richness) %>%
  step_sqrt(tree_canopy_2000 ) %>%
  step_sqrt(tree_loss) %>%
  step_sqrt(three_year_tree_loss) %>%
#  step_log(population) %>%
  update_role(rowid, new_role = "ID") %>% 
  step_string2factor(is_bangladesh) 
#  step_dummy(continent) %>%
#  step_dummy(biome_factor) 


test_rec <- recipe(is_spillover_fixed ~ ., data = data_train) %>%
  update_role(rowid, new_role ="ID") %>%
  step_downsample(is_spillover_fixed)

```

Create workflow for convenience in tuning.

```{r}

tune_spec <- 
  workflow() %>% 
  add_model(rf_tune_spec) %>% 
  add_recipe(rf_rec)

```

Fit the model using a grid of hyperparameters, which will help us narrow in on which levels are appropriate for this data.

*** This command specifies that our metric will be roc_auc - later lets use accuracy as well/instead of this. 

```{r}

set.seed(345)

rf_res <- 
  tune_spec %>% 
  tune_grid(val_set,
            grid = 25,
            control = control_grid(save_pred = TRUE),
            metrics = metric_set(roc_auc))

#> i Creating pre-processing data to finalize unknown parameter: mtry
```



```{r}
rf_res %>% 
  show_best(metric = "roc_auc")
```


```{r}
rf_best <- 
  rf_res %>% 
  select_best(metric = "roc_auc")
```


```{r}
rf_res %>% 
  collect_predictions()
```


```{r}
rf_auc <- 
  rf_res %>% 
  collect_predictions(parameters = rf_best) %>% 
  roc_curve(is_spillover_fixed, .pred_Yes) %>% 
  mutate(model = "Random Forest")
```


```{r}
# the last model
last_rf_mod <- 
  rand_forest(mtry = 8, min_n = 7, trees = 1000) %>% 
  set_engine("ranger", num.threads = cores, importance = "impurity") %>% 
  set_mode("classification")
# the last workflow
last_rf_workflow <- 
  rf_workflow %>% 
  update_model(last_rf_mod)
# the last fit
set.seed(345)
last_rf_fit <- 
  last_rf_workflow %>% 
  last_fit(data_split)
last_rf_fit
```








Rewriting join section to be less memory intensive - leaving mutate() sections for later. Also breaking the data set up by year, noting that the original range is 2001 to 2020

```{r}

long_data_all_years <- long_data_raw %>% 
  mutate(is_spillover_fixed = case_when(
    is_spillover == "Yes" ~ "Yes",
    is.na(is_spillover) ~ "No",
    TRUE ~ "Other")) %>%
  select(!is_spillover:bangla_hit)

rm(long_data_raw)

long_data_joined %>% group_by(the_year) %>% count
  
long_data_joined %>% filter(the_year < 2010)

filter(the_year > 2002)

```
  %>%
  filter(!the_year %in% c("2000", "2001", "2002"))
 
 %>%
  drop_na() 

%>%
  mutate(biome_factor = as.factor(biome)) 
  
  %>%
  mutate(tree_loss = (tree_loss * 0.000001) +1,
         three_year_tree_loss = (three_year_tree_loss * 0.000001) + 1,
         tree_canopy_2000 = tree_canopy_2000 * 0.000001 + 1) 
  
  

long_data_joined %>% select(!is_spillover:bangla_hit) %>% str

```

Not sure what most of this does.

```{r}
long_data_joined <- long_data_raw %>%
  mutate(is_spillover_fixed = case_when(
    is_spillover == "Yes" ~ "Yes",
    is.na(is_spillover) ~ "No",
    TRUE ~ "Other"
  )) %>%
  select(!is_spillover:bangla_hit) %>%
  mutate(biome_factor = as.factor(biome)) %>%
  select(!biome) %>%
  filter(!the_year %in% c("2000", "2001", "2002")) %>%
  drop_na() %>%
  mutate(tree_loss = (tree_loss * 0.000001) +1,
         three_year_tree_loss = (three_year_tree_loss * 0.000001) + 1,
         tree_canopy_2000 = tree_canopy_2000 * 0.000001 + 1) 
```

```{r}
hits <- long_data_joined  %>%
  filter(is_spillover_fixed == "Yes")
```

```{r}
control_hits <- long_data_joined %>%
  filter(is_spillover_fixed == "No") %>%
  sample_frac(0.1)
```

```{r}
analysis_set <- bind_rows(hits, control_hits) %>%
  select(is_spillover_fixed, bat_species_richness, elevation, the_year, tmmn, tmmx, tree_loss, precip, evapo, is_bangladesh, continent)
```
setting aside population for now

```{r}
the_recipe <- recipe(is_spillover_fixed ~ ., data = analysis_set) %>%
  step_string2factor(is_spillover_fixed) %>%
  step_relevel(is_spillover_fixed, ref_level = "Yes") %>%
  step_sqrt(tree_loss)
  #update_role(rowid, new_role = "id variable") %>% 
  #step_normalize(tree_loss)
  #step_string2factor(is_bangladesh) %>%
  #step_dummy(continent) %>%
  #step_dummy(biome_factor) 
```

```{r}
analysis_set_juiced <- the_recipe %>% prep() %>% juice()
```
```{r}
fitted_logistic_model<- logistic_reg() %>%
        # Set the engine
        set_engine("glm") %>%
        # Set the mode
        set_mode("classification") %>%
        # Fit the model
        fit(is_spillover_fixed ~ ., data = analysis_set_juiced)
```
